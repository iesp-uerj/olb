---
params:
  ini: "2019-01-01"
  end: "2019-02-01"
  set_title: "Relatório de Acompanhamento"
  set_author: "Observatório do Legislativo Brasileiro"
  tema: "Economia"
title: "`r params$set_title`"
author: "`r params$set_author`"
date: "`r paste0(params$tema, ' (', format(as.Date(params$ini), '%d/%m/%Y'), ' - ', format(as.Date(params$end), '%d/%m/%Y'), ')')`"
output: 
  html_document:
    toc: true
    toc_float:
      smooth_scroll: true
    toc_depth: 1
    number_sections: false
    theme: readable
    highlight: tango
    keep_md: true
---

```{r setup, include=FALSE}
# Opts
knitr::opts_chunk$set(echo = TRUE)

# Pacotes
library(highcharter)
library(tidyverse)
library(DT)

# Dados
x <- proposicoes(params$ini, params$end)

props <- x$props %>%
  filter(tema == params$tema)
autores <- x$autores %>%
  filter(tema == params$tema)
```


# Proposições

No período entre `r format(as.Date(params$ini), "%d/%m/%Y")` e `r format(as.Date(params$end), "%d/%m/%Y")`, `r nrow(props)` proposições legislativas na área de `r params$tema` foram introduzidas. No gráfico abaixo, é possível visualizar o número de proposições introduzidas por data.
<br>
<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
x <- props %>%
  mutate(dataApresentacao = as.Date(dataApresentacao)) %>%
  group_by(dataApresentacao) %>%
  summarise(n = n())

highchart() %>% 
  hc_title(text = "Proposições introduzidas no período") %>%
  hc_subtitle(text = paste0("Tema: ", params$tema)) %>%
  hc_xAxis(categories = x$dataApresentacao) %>% 
  hc_add_series(name = "Proposições", data = x$n) %>%
  hc_colors(c("#4582ec")) %>%
  hc_credits(enabled = TRUE, # add credits
             text = "www.olb.org.br",
             href = "http://olb.org.br/")

```


Quanto à filiação partidária, `r autores %>% unique %>% length` legendas diferentes tivereram proposições submetidas pelos seus(as) deputados(as) no período.
<br>
<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
autores %>%
  group_by(partido) %>%
  summarise(n = n()) %>%
  mutate(partido = ifelse(is.na(partido), "Orgãos / Outros", partido)) %>%
  hchart("treemap", hcaes(x = partido, value = n, color = n)) %>%
  hc_title(text = "Proposições introduzidas por partido") %>%
  hc_subtitle(text = paste0("Tema: ", params$tema)) %>%
  hc_credits(enabled = TRUE, # add credits
             text = "www.olb.org.br",
             href = "http://olb.org.br/")
```

<br>
<br>


# Tramitação

As `r nrow(props)` proposições introduzidas no período estão tramitando em `r length(unique(props$ultimoStatus_siglaOrgao))` órgãos. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
props %>%
  group_by(ultimoStatus_siglaOrgao) %>%
  summarise(n = n()) %>%
  mutate(partido = ifelse(is.na(ultimoStatus_siglaOrgao), "Outros", ultimoStatus_siglaOrgao)) %>%
  hchart("treemap", hcaes(x = ultimoStatus_siglaOrgao, value = n, color = n)) %>%
  hc_title(text = "Proposições por local de tramitação") %>%
  hc_subtitle(text = paste0("Tema: ", params$tema)) %>%
  hc_credits(enabled = TRUE, # add credits
             text = "www.olb.org.br",
             href = "http://olb.org.br/")
```
<br>
<br>


# Detalhes das proposições {.tabset}

Nas abas abaixo, é possível consultar informações específicas das proposições por tipo (Projeto de Lei, Medida Provisória, etc).
<br>
<br>


## Projetos de Lei


```{r echo=FALSE, message=FALSE, warning=FALSE}
props %>%
  filter(siglaTipo == "PL") %>%
  mutate(prop = paste0("PL ", numero, "/", ano)) %>%
  mutate(prop = paste0('<a href="', urlInteiroTeor, '" target="_blank">', prop,'</a>')) %>%
  mutate(data = format(as.Date(dataApresentacao), "%d/%m/%Y")) %>%
  mutate(ementa = substr(ementa, 1, 120) %>% paste0("...")) %>%
  mutate(autor = gsub("(NA/NA)", "", autor)) %>%
  select(prop, autor, data, ementa) %>%
  setNames(c("Proposição", "Autor(a)", "Data de apresentação", "Ementa")) %>%
  datatable(rownames = F, escape = FALSE,
            extensions = 'Buttons',
            options = list(
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20),
  dom = 'Bfrtip',
  language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'),
  buttons = c('excel', 'pdf')
))
```


## Medidas Provisórias


```{r echo=FALSE, message=FALSE, warning=FALSE}
props %>%
  filter(siglaTipo == "PEC") %>%
  mutate(prop = paste0("PEC ", numero, "/", ano)) %>%
  mutate(prop = paste0('<a href="', urlInteiroTeor, '" target="_blank">', prop,'</a>')) %>%
  mutate(data = format(as.Date(dataApresentacao), "%d/%m/%Y")) %>%
  mutate(ementa = substr(ementa, 1, 120) %>% paste0("...")) %>%
  mutate(autor = gsub("(NA/NA)", "", autor)) %>%
  select(prop, autor, data, ementa) %>%
  setNames(c("Proposição", "Autor(a)", "Data de apresentação", "Ementa")) %>%
  datatable(rownames = F, escape = FALSE,
            extensions = 'Buttons',
            options = list(
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20),
  dom = 'Bfrtip',
  language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'),
  buttons = c('excel', 'pdf')
))
```


## Projetos de Lei Complementar


```{r echo=FALSE, message=FALSE, warning=FALSE}
props %>%
  filter(siglaTipo == "PLP") %>%
  mutate(prop = paste0("PLP ", numero, "/", ano)) %>%
  mutate(prop = paste0('<a href="', urlInteiroTeor, '" target="_blank">', prop,'</a>')) %>%
  mutate(data = format(as.Date(dataApresentacao), "%d/%m/%Y")) %>%
  mutate(ementa = substr(ementa, 1, 120) %>% paste0("...")) %>%
  mutate(autor = gsub("(NA/NA)", "", autor)) %>%
  select(prop, autor, data, ementa) %>%
  setNames(c("Proposição", "Autor(a)", "Data de apresentação", "Ementa")) %>%
  datatable(rownames = F, escape = FALSE,
            extensions = 'Buttons',
            options = list(
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20),
  dom = 'Bfrtip',
  language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'),
  buttons = c('excel', 'pdf')
))
```


## Projeos de Emenda Constitucional


```{r echo=FALSE, message=FALSE, warning=FALSE}
props %>%
  filter(siglaTipo == "PEC") %>%
  mutate(prop = paste0("PEC ", numero, "/", ano)) %>%
  mutate(prop = paste0('<a href="', urlInteiroTeor, '" target="_blank">', prop,'</a>')) %>%
  mutate(data = format(as.Date(dataApresentacao), "%d/%m/%Y")) %>%
  mutate(ementa = substr(ementa, 1, 120) %>% paste0("...")) %>%
  mutate(autor = gsub("(NA/NA)", "", autor)) %>%
  select(prop, autor, data, ementa) %>%
  setNames(c("Proposição", "Autor(a)", "Data de apresentação", "Ementa")) %>%
  datatable(rownames = F, escape = FALSE,
            extensions = 'Buttons',
            options = list(
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20),
  dom = 'Bfrtip',
  language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'),
  buttons = c('excel', 'pdf')
))
```


# Autores

<br>
<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
autores %>%
  filter(tipo == "Deputado") %>%
  mutate(peca = paste0(siglaTipo, " ", numero, "/", lubridate::year(dataApresentacao))) %>%
  mutate(peca = paste0('<a href="', urlInteiroTeor, '" target="_blank">', peca,'</a>')) %>%
  group_by(nome, partido, uf) %>%
  summarise(n = n(), pecas = paste0(peca, collapse = ", ")) %>%
  mutate(pecas = paste0("(", pecas, ")")) %>%
  setNames(c("Deputado(a)", "Partido", "UF", "Número de proposições", "Proposições")) %>%
  datatable(rownames = F, escape = FALSE,
            extensions = 'Buttons',
            options = list(
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20),
  dom = 'Bfrtip',
  language = list(url = 'http://cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'),
  buttons = c('excel', 'pdf')
))
```
